version: '3.8'

services:

  middleman:
    build:
      context: ./middleman
      dockerfile: Dockerfile
    container_name: resource_broker
    ports:
      - "5000:5000"
    environment:
      - MIDDLEMAN_PORT=5000
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    volumes:
      - ./middleman:/app
      - middleman_logs:/app/logs
    depends_on:
      - redis
    networks:
      - cloud_network
    restart: unless-stopped

 
  redis:
    image: redis:7-alpine
    container_name: redis_cache
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - cloud_network
    restart: unless-stopped
    command: redis-server --appendonly yes


  
  host_berlin:
    build:
      context: ./provider
      dockerfile: Dockerfile
    container_name: Berlin
    environment:
      - HOST_ID=host_berlin
      - HOST_NAME=Berlin-01
      - LOCATION=europe
      - MIDDLEMAN_URL=http://middleman:5000
      - CPU_CAPACITY=8
      - MEMORY_CAPACITY=16384
      - UPTIME_PROBABILITY=0.95
      - FAILURE_SIMULATION=true
    volumes:
      - ./provider:/app
      - berlin_data:/app/data
    depends_on:
      - middleman
    networks:
      - cloud_network
    restart: unless-stopped

  host_johanngeorgenstadt:
    build:
      context: ./provider
      dockerfile: Dockerfile
    container_name: Johanngeorgenstadt
    environment:
      - HOST_ID=host_johanngeorgenstadt
      - HOST_NAME=Johanngeorgenstadt-01
      - LOCATION=europe
      - MIDDLEMAN_URL=http://middleman:5000
      - CPU_CAPACITY=4
      - MEMORY_CAPACITY=8192
      - UPTIME_PROBABILITY=0.90
      - FAILURE_SIMULATION=true
    volumes:
      - ./provider:/app
      - johanngeorgenstadt_data:/app/data
    depends_on:
      - middleman
    networks:
      - cloud_network
    restart: unless-stopped

 
  host_nyc:
    build:
      context: ./provider
      dockerfile: Dockerfile
    container_name: NewYork
    environment:
      - HOST_ID=host_nyc
      - HOST_NAME=NYC-01
      - LOCATION=north_america
      - MIDDLEMAN_URL=http://middleman:5000
      - CPU_CAPACITY=16
      - MEMORY_CAPACITY=32768
      - UPTIME_PROBABILITY=0.98
      - FAILURE_SIMULATION=true
    volumes:
      - ./provider:/app
      - nyc_data:/app/data
    depends_on:
      - middleman
    networks:
      - cloud_network
    restart: unless-stopped

  host_sf:
    build:
      context: ./provider
      dockerfile: Dockerfile
    container_name: SanFrancisco
    environment:
      - HOST_ID=host_sf
      - HOST_NAME=SF-01
      - LOCATION=north_america
      - MIDDLEMAN_URL=http://middleman:5000
      - CPU_CAPACITY=8
      - MEMORY_CAPACITY=16384
      - UPTIME_PROBABILITY=0.92
      - FAILURE_SIMULATION=true
    volumes:
      - ./provider:/app
      - sf_data:/app/data
    depends_on:
      - middleman
    networks:
      - cloud_network
    restart: unless-stopped

 
  host_tokyo:
    build:
      context: ./provider
      dockerfile: Dockerfile
    container_name: Tokyo
    environment:
      - HOST_ID=host_tokyo
      - HOST_NAME=Tokyo-01
      - LOCATION=asia
      - MIDDLEMAN_URL=http://middleman:5000
      - CPU_CAPACITY=12
      - MEMORY_CAPACITY=24576
      - UPTIME_PROBABILITY=0.96
      - FAILURE_SIMULATION=true
    volumes:
      - ./provider:/app
      - tokyo_data:/app/data
    depends_on:
      - middleman
    networks:
      - cloud_network
    restart: unless-stopped

  host_tuvalu:
    build:
      context: ./provider
      dockerfile: Dockerfile
    container_name: Tuvalu
    environment:
      - HOST_ID=host_tuvalu
      - HOST_NAME=Tuvalu-01
      - LOCATION=oceania
      - MIDDLEMAN_URL=http://middleman:5000
      - CPU_CAPACITY=6
      - MEMORY_CAPACITY=12288
      - UPTIME_PROBABILITY=0.88
      - FAILURE_SIMULATION=true
    volumes:
      - ./provider:/app
      - tuvalu_data:/app/data
    depends_on:
      - middleman
    networks:
      - cloud_network
    restart: unless-stopped

  
  host_edge:
    build:
      context: ./provider
      dockerfile: Dockerfile
    container_name: EdgeNode
    environment:
      - HOST_ID=host_edge
      - HOST_NAME=Edge-01
      - LOCATION=europe
      - MIDDLEMAN_URL=http://middleman:5000
      - CPU_CAPACITY=2
      - MEMORY_CAPACITY=4096
      - UPTIME_PROBABILITY=0.70
      - FAILURE_SIMULATION=true
    volumes:
      - ./provider:/app
      - edge_data:/app/data
    depends_on:
      - middleman
    networks:
      - cloud_network
    restart: unless-stopped

  
  client:
    build:
      context: ./user
      dockerfile: Dockerfile
    container_name: resource_client
    environment:
      - MIDDLEMAN_URL=http://middleman:5000
      - TASK_INTERVAL=20
    volumes:
      - ./user:/app
      - user_logs:/app/logs
    depends_on:
      - middleman
    networks:
      - cloud_network
    restart: unless-stopped

  
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
    networks:
      - cloud_network
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_SECURITY_ADMIN_USER=admin
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources
    depends_on:
      - prometheus
    networks:
      - cloud_network
    restart: unless-stopped

networks:
  cloud_network:
    driver: bridge

volumes:
  middleman_logs:
  redis_data:
  berlin_data:
  johanngeorgenstadt_data:
  nyc_data:
  sf_data:
  tokyo_data:
  tuvalu_data:
  edge_data:
  user_logs:
  prometheus_data:
  grafana_data: